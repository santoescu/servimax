/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { HttpParams } from '@angular/common/http';
import { tdHttpRESTParam } from '../params/abstract-param.decorator';
import { of } from 'rxjs';
/** @type {?} */
export var NOOP_HTTP = of(undefined);
/**
 * Method used to copy parameters from an array or HttpParams object
 * into a centrilized HttpParams object
 * \@internal
 * @param {?} target
 * @param {?} source
 * @return {?}
 */
export function parseParams(target, source) {
    /** @type {?} */
    var queryParams = target;
    if (source instanceof HttpParams) {
        source.keys().forEach(function (key) {
            // skip if value is undefined
            if (((/** @type {?} */ (source))).get(key) !== undefined) {
                ((/** @type {?} */ (source))).getAll(key).forEach(function (value, index) {
                    if (index === 0) {
                        queryParams = queryParams.set(key, value);
                    }
                    else {
                        queryParams = queryParams.append(key, value);
                    }
                });
            }
        });
    }
    else {
        var _loop_1 = function (key) {
            // skip if value is undefined
            if ((/** @type {?} */ (source[key])) !== undefined) {
                if (source[key] instanceof Array) {
                    ((/** @type {?} */ (source[key]))).forEach(function (value, index) {
                        if (index === 0) {
                            queryParams = queryParams.set(key, value);
                        }
                        else {
                            queryParams = queryParams.append(key, value);
                        }
                    });
                }
                else {
                    queryParams = queryParams.set(key, (/** @type {?} */ (source[key])));
                }
            }
        };
        for (var key in source) {
            _loop_1(key);
        }
    }
    return queryParams;
}
/**
 * Abstract implementation of the http method decorator
 * \@internal
 * @param {?} config
 * @return {?}
 */
export function TdAbstractMethod(config) {
    return function (target, propertyName, descriptor) {
        /** @type {?} */
        var wrappedFunction = descriptor.value;
        // replace method call with our own and proxy it
        descriptor.value = function () {
            var e_1, _a, e_2, _b;
            try {
                /** @type {?} */
                var replacedPath = config.path;
                /** @type {?} */
                var parameters = Reflect.getOwnMetadata(tdHttpRESTParam, target, propertyName);
                /** @type {?} */
                var newArgs = [];
                /** @type {?} */
                var body = void 0;
                /** @type {?} */
                var queryParams = new HttpParams();
                if (parameters) {
                    try {
                        // map parameters and see which type they are to act on them
                        for (var parameters_1 = tslib_1.__values(parameters), parameters_1_1 = parameters_1.next(); !parameters_1_1.done; parameters_1_1 = parameters_1.next()) {
                            var parameter = parameters_1_1.value;
                            if (parameter.type === 'param') {
                                newArgs[parameter.index] = arguments[parameter.index];
                                replacedPath = replacedPath.replace(':' + parameter.param, arguments[parameter.index]);
                            }
                            else if (parameter.type === 'body') {
                                newArgs[parameter.index] = arguments[parameter.index];
                                body = arguments[parameter.index];
                            }
                            else if (parameter.type === 'queryParams') {
                                newArgs[parameter.index] = arguments[parameter.index];
                                /** @type {?} */
                                var qParams = arguments[parameter.index];
                                if (config.options && config.options.params) {
                                    queryParams = parseParams(queryParams, config.options.params);
                                }
                                if (qParams) {
                                    queryParams = parseParams(queryParams, qParams);
                                }
                            }
                        }
                    }
                    catch (e_1_1) { e_1 = { error: e_1_1 }; }
                    finally {
                        try {
                            if (parameters_1_1 && !parameters_1_1.done && (_a = parameters_1.return)) _a.call(parameters_1);
                        }
                        finally { if (e_1) throw e_1.error; }
                    }
                }
                // tslint:disable-next-line
                /** @type {?} */
                var url = this.baseUrl + replacedPath;
                /** @type {?} */
                var options = Object.assign({}, config.options, {
                    body: body,
                    params: queryParams,
                });
                // tslint:disable-next-line
                /** @type {?} */
                var request = this.buildRequest(config.method, url, options);
                if (parameters) {
                    try {
                        // see which one was the response parameter so we can set the request observable
                        for (var parameters_2 = tslib_1.__values(parameters), parameters_2_1 = parameters_2.next(); !parameters_2_1.done; parameters_2_1 = parameters_2.next()) {
                            var parameter = parameters_2_1.value;
                            if (parameter.type === 'response') {
                                newArgs[parameter.index] = request;
                            }
                        }
                    }
                    catch (e_2_1) { e_2 = { error: e_2_1 }; }
                    finally {
                        try {
                            if (parameters_2_1 && !parameters_2_1.done && (_b = parameters_2.return)) _b.call(parameters_2);
                        }
                        finally { if (e_2) throw e_2.error; }
                    }
                }
                // tslint:disable-next-line
                /** @type {?} */
                var response = wrappedFunction.apply(this, newArgs);
                // if the response is NOOP_HTTP or undefined, then we return the request as it is
                // else we return the response from the inner function
                if (response === NOOP_HTTP || response === undefined) {
                    return request;
                }
                else {
                    return response;
                }
            }
            catch (error) {
                // tslint:disable-next-line
                console.error(error);
            }
        };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWJzdHJhY3QtbWV0aG9kLmRlY29yYXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bjb3ZhbGVudC9odHRwLyIsInNvdXJjZXMiOlsiYWN0aW9ucy9tZXRob2RzL2Fic3RyYWN0LW1ldGhvZC5kZWNvcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHbEQsT0FBTyxFQUFlLGVBQWUsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBRWxGLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7O0FBSXRDLE1BQU0sS0FBTyxTQUFTLEdBQW9CLEVBQUUsQ0FBQyxTQUFTLENBQUM7Ozs7Ozs7OztBQU92RCxNQUFNLFVBQVUsV0FBVyxDQUFDLE1BQWtCLEVBQUUsTUFBdUQ7O1FBQ2pHLFdBQVcsR0FBZSxNQUFNO0lBQ3BDLElBQUksTUFBTSxZQUFZLFVBQVUsRUFBRTtRQUNoQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQUMsR0FBVztZQUNoQyw2QkFBNkI7WUFDN0IsSUFBSSxDQUFDLG1CQUFZLE1BQU0sRUFBQSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxLQUFLLFNBQVMsRUFBRTtnQkFDL0MsQ0FBQyxtQkFBWSxNQUFNLEVBQUEsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxLQUFhLEVBQUUsS0FBYTtvQkFDcEUsSUFBSSxLQUFLLEtBQUssQ0FBQyxFQUFFO3dCQUNmLFdBQVcsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztxQkFDM0M7eUJBQU07d0JBQ0wsV0FBVyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO3FCQUM5QztnQkFDSCxDQUFDLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQyxDQUFD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c291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgVGRIdHRwTWV0aG9kLCBJVGRIdHRwUkVTVE9wdGlvbnMsIElUZEh0dHBSRVNUT3B0aW9uc1dpdGhCb2R5IH0gZnJvbSAnLi4vLi4vaHR0cC5pbnRlcmZhY2VzJztcbmltcG9ydCB7IFRkUGFyYW1UeXBlLCB0ZEh0dHBSRVNUUGFyYW0gfSBmcm9tICcuLi9wYXJhbXMvYWJzdHJhY3QtcGFyYW0uZGVjb3JhdG9yJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcblxuZGVjbGFyZSBjb25zdCBSZWZsZWN0OiBhbnk7XG5cbmV4cG9ydCBjb25zdCBOT09QX0hUVFA6IE9ic2VydmFibGU8YW55PiA9IG9mKHVuZGVmaW5lZCk7XG5cbi8qKlxuICogTWV0aG9kIHVzZWQgdG8gY29weSBwYXJhbWV0ZXJzIGZyb20gYW4gYXJyYXkgb3IgSHR0cFBhcmFtcyBvYmplY3RcbiAqIGludG8gYSBjZW50cmlsaXplZCBIdHRwUGFyYW1zIG9iamVjdFxuICogQGludGVybmFsXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwYXJzZVBhcmFtcyh0YXJnZXQ6IEh0dHBQYXJhbXMsIHNvdXJjZTogSHR0cFBhcmFtcyB8IHtba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBzdHJpbmdbXX0pOiBIdHRwUGFyYW1zIHtcbiAgbGV0IHF1ZXJ5UGFyYW1zOiBIdHRwUGFyYW1zID0gdGFyZ2V0O1xuICBpZiAoc291cmNlIGluc3RhbmNlb2YgSHR0cFBhcmFtcykge1xuICAgIHNvdXJjZS5rZXlzKCkuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIC8vIHNraXAgaWYgdmFsdWUgaXMgdW5kZWZpbmVkXG4gICAgICBpZiAoKDxIdHRwUGFyYW1zPnNvdXJjZSkuZ2V0KGtleSkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAoPEh0dHBQYXJhbXM+c291cmNlKS5nZXRBbGwoa2V5KS5mb3JFYWNoKCh2YWx1ZTogc3RyaW5nLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICBxdWVyeVBhcmFtcyA9IHF1ZXJ5UGFyYW1zLnNldChrZXksIHZhbHVlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcXVlcnlQYXJhbXMgPSBxdWVyeVBhcmFtcy5hcHBlbmQoa2V5LCB2YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBmb3IgKGxldCBrZXkgaW4gc291cmNlKSB7XG4gICAgICAvLyBza2lwIGlmIHZhbHVlIGlzIHVuZGVmaW5lZFxuICAgICAgaWYgKDxhbnk+c291cmNlW2tleV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBpZiAoc291cmNlW2tleV0gaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICAgICg8c3RyaW5nW10+c291cmNlW2tleV0pLmZvckVhY2goKHZhbHVlOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICAgICAgICBxdWVyeVBhcmFtcyA9IHF1ZXJ5UGFyYW1zLnNldChrZXksIHZhbHVlKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHF1ZXJ5UGFyYW1zID0gcXVlcnlQYXJhbXMuYXBwZW5kKGtleSwgdmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHF1ZXJ5UGFyYW1zID0gcXVlcnlQYXJhbXMuc2V0KGtleSwgPGFueT5zb3VyY2Vba2V5XSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcmV0dXJuIHF1ZXJ5UGFyYW1zO1xufVxuXG4vKipcbiAqIEFic3RyYWN0IGltcGxlbWVudGF0aW9uIG9mIHRoZSBodHRwIG1ldGhvZCBkZWNvcmF0b3JcbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgZnVuY3Rpb24gVGRBYnN0cmFjdE1ldGhvZChjb25maWc6IHtcbiAgbWV0aG9kOiBUZEh0dHBNZXRob2QsXG4gIHBhdGg6IHN0cmluZyxcbiAgb3B0aW9ucz86IElUZEh0dHBSRVNUT3B0aW9ucyxcbn0pOiBGdW5jdGlvbiB7XG4gIHJldHVybiBmdW5jdGlvbiAodGFyZ2V0OiBhbnksIHByb3BlcnR5TmFtZTogc3RyaW5nLCBkZXNjcmlwdG9yOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxGdW5jdGlvbj4pOiBhbnkge1xuICAgIGxldCB3cmFwcGVkRnVuY3Rpb246IEZ1bmN0aW9uID0gZGVzY3JpcHRvci52YWx1ZTtcbiAgICAvLyByZXBsYWNlIG1ldGhvZCBjYWxsIHdpdGggb3VyIG93biBhbmQgcHJveHkgaXRcbiAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24gKCk6IGFueSB7XG4gICAgICB0cnkge1xuICAgICAgICBsZXQgcmVwbGFjZWRQYXRoOiBzdHJpbmcgPSBjb25maWcucGF0aDtcbiAgICAgICAgbGV0IHBhcmFtZXRlcnM6IHsgaW5kZXg6IG51bWJlciwgcGFyYW06IHN0cmluZywgdHlwZTogVGRQYXJhbVR5cGUgfVtdID0gUmVmbGVjdC5nZXRPd25NZXRhZGF0YSh0ZEh0dHBSRVNUUGFyYW0sIHRhcmdldCwgcHJvcGVydHlOYW1lKTtcbiAgICAgICAgbGV0IG5ld0FyZ3M6IGFueVtdID0gW107XG4gICAgICAgIGxldCBib2R5OiBhbnk7XG4gICAgICAgIGxldCBxdWVyeVBhcmFtczogSHR0cFBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKCk7XG4gICAgICAgIGlmIChwYXJhbWV0ZXJzKSB7XG4gICAgICAgICAgLy8gbWFwIHBhcmFtZXRlcnMgYW5kIHNlZSB3aGljaCB0eXBlIHRoZXkgYXJlIHRvIGFjdCBvbiB0aGVtXG4gICAgICAgICAgZm9yIChsZXQgcGFyYW1ldGVyIG9mIHBhcmFtZXRlcnMpIHtcbiAgICAgICAgICAgIGlmIChwYXJhbWV0ZXIudHlwZSA9PT0gJ3BhcmFtJykge1xuICAgICAgICAgICAgICBuZXdBcmdzW3BhcmFtZXRlci5pbmRleF0gPSBhcmd1bWVudHNbcGFyYW1ldGVyLmluZGV4XTtcbiAgICAgICAgICAgICAgcmVwbGFjZWRQYXRoID0gcmVwbGFjZWRQYXRoLnJlcGxhY2UoJzonICsgcGFyYW1ldGVyLnBhcmFtLCBhcmd1bWVudHNbcGFyYW1ldGVyLmluZGV4XSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHBhcmFtZXRlci50eXBlID09PSAnYm9keScpIHtcbiAgICAgICAgICAgICAgbmV3QXJnc1twYXJhbWV0ZXIuaW5kZXhdID0gYXJndW1lbnRzW3BhcmFtZXRlci5pbmRleF07XG4gICAgICAgICAgICAgIGJvZHkgPSBhcmd1bWVudHNbcGFyYW1ldGVyLmluZGV4XTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocGFyYW1ldGVyLnR5cGUgPT09ICdxdWVyeVBhcmFtcycpIHtcbiAgICAgICAgICAgICAgbmV3QXJnc1twYXJhbWV0ZXIuaW5kZXhdID0gYXJndW1lbnRzW3BhcmFtZXRlci5pbmRleF07XG4gICAgICAgICAgICAgIGxldCBxUGFyYW1zOiBIdHRwUGFyYW1zIHwge1trZXk6IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdfSA9IGFyZ3VtZW50c1twYXJhbWV0ZXIuaW5kZXhdO1xuICAgICAgICAgICAgICBpZiAoY29uZmlnLm9wdGlvbnMgJiYgY29uZmlnLm9wdGlvbnMucGFyYW1zKSB7XG4gICAgICAgICAgICAgICAgcXVlcnlQYXJhbXMgPSBwYXJzZVBhcmFtcyhxdWVyeVBhcmFtcywgY29uZmlnLm9wdGlvbnMucGFyYW1zKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBpZiAocVBhcmFtcykge1xuICAgICAgICAgICAgICAgIHF1ZXJ5UGFyYW1zID0gcGFyc2VQYXJhbXMocXVlcnlQYXJhbXMsIHFQYXJhbXMpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICAgICAgICBsZXQgdXJsOiBzdHJpbmcgPSB0aGlzLmJhc2VVcmwgKyByZXBsYWNlZFBhdGg7XG4gICAgICAgIGxldCBvcHRpb25zOiBJVGRIdHRwUkVTVE9wdGlvbnNXaXRoQm9keSA9IE9iamVjdC5hc3NpZ24oe30sIGNvbmZpZy5vcHRpb25zLCB7XG4gICAgICAgICAgYm9keTogYm9keSxcbiAgICAgICAgICBwYXJhbXM6IHF1ZXJ5UGFyYW1zLFxuICAgICAgICB9KTtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgICAgIGxldCByZXF1ZXN0OiBhbnkgPSB0aGlzLmJ1aWxkUmVxdWVzdChjb25maWcubWV0aG9kLCB1cmwsIG9wdGlvbnMpO1xuICAgICAgICBpZiAocGFyYW1ldGVycykge1xuICAgICAgICAgIC8vIHNlZSB3aGljaCBvbmUgd2FzIHRoZSByZXNwb25zZSBwYXJhbWV0ZXIgc28gd2UgY2FuIHNldCB0aGUgcmVxdWVzdCBvYnNlcnZhYmxlXG4gICAgICAgICAgZm9yIChsZXQgcGFyYW1ldGVyIG9mIHBhcmFtZXRlcnMpIHtcbiAgICAgICAgICAgIGlmIChwYXJhbWV0ZXIudHlwZSA9PT0gJ3Jlc3BvbnNlJykge1xuICAgICAgICAgICAgICBuZXdBcmdzW3BhcmFtZXRlci5pbmRleF0gPSByZXF1ZXN0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcbiAgICAgICAgbGV0IHJlc3BvbnNlOiBhbnkgPSB3cmFwcGVkRnVuY3Rpb24uYXBwbHkodGhpcywgbmV3QXJncyk7XG4gICAgICAgIC8vIGlmIHRoZSByZXNwb25zZSBpcyBOT09QX0hUVFAgb3IgdW5kZWZpbmVkLCB0aGVuIHdlIHJldHVybiB0aGUgcmVxdWVzdCBhcyBpdCBpc1xuICAgICAgICAvLyBlbHNlIHdlIHJldHVybiB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgaW5uZXIgZnVuY3Rpb25cbiAgICAgICAgaWYgKHJlc3BvbnNlID09PSBOT09QX0hUVFAgfHwgcmVzcG9uc2UgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybiByZXF1ZXN0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgfVxuICAgIH07XG4gIH07XG59XG4iXX0=